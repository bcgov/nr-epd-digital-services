FROM node:16.14.0-alpine
#FROM artifacts.developer.gov.bc.ca/docker-remote/node:14.17.1-alpine

# Set cache directory within the user's home directory
ENV NPM_CONFIG_CACHE=/home/node/.npm

WORKDIR /app

# A wildcard is used to ensure both package.json AND package-lock.json are copied
# Copy package.json and package-lock.json
COPY package*.json ./

# Set NODE_ENV environment variable

RUN npm ci


#RUN npm build

# Bundle app source
COPY . .

# Set permissions for the application directory
RUN chmod -R 755 /app
# Ensure ownership of .npm folder
RUN mkdir -p /home/node/.npm \
    && chown -R node:node /home/node/.npm

# Install PostgreSQL client if needed
# Install PostgreSQL client
RUN apk add --no-cache postgresql-client

# Disable npm cache
RUN npm config set cache false
# Set executable permissions for scripts
RUN chmod +x initDB.sh


ENTRYPOINT ["sh", "initDB.sh"]