<?xml version="1.0" encoding="UTF-8"?>
<bpmn:definitions xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL" xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" xmlns:dc="http://www.omg.org/spec/DD/20100524/DC" xmlns:camunda="http://camunda.org/schema/1.0/bpmn" xmlns:di="http://www.omg.org/spec/DD/20100524/DI" xmlns:modeler="http://camunda.org/schema/modeler/1.0" id="Definitions_0ws6ff6" targetNamespace="http://bpmn.io/schema/bpmn" exporter="Camunda Modeler" exporterVersion="5.8.0" modeler:executionPlatform="Camunda Platform" modeler:executionPlatformVersion="7.18.0"><bpmn:process id="Process_1bi69f0" name="Ches Notification Test" isExecutable="true"><bpmn:startEvent id="StartEvent_1" name="start"><bpmn:outgoing>Flow_0zfq4uk</bpmn:outgoing></bpmn:startEvent><bpmn:sequenceFlow id="Flow_0zfq4uk" sourceRef="StartEvent_1" targetRef="Activity_0ghr926" /><bpmn:endEvent id="Event_1wzeb82" name="end"><bpmn:incoming>Flow_0ix6j1b</bpmn:incoming></bpmn:endEvent><bpmn:serviceTask id="Activity_0ghr926" name="Get OAuth Token"><bpmn:extensionElements><camunda:connector><camunda:inputOutput><camunda:inputParameter name="url"><camunda:script scriptFormat="groovy">def authVar = System.getenv('CHES_AUTH_URL')
println "Auth URL" 
println authVar</camunda:script></camunda:inputParameter><camunda:inputParameter name="method">POST</camunda:inputParameter><camunda:inputParameter name="headers"><camunda:map><camunda:entry key="Content-Type">application/x-www-form-urlencoded</camunda:entry></camunda:map></camunda:inputParameter><camunda:inputParameter name="payload"><camunda:script scriptFormat="javascript">var system = java.lang.System;
var clientId=system.getenv('CHES_CLIENT_ID');
var clientSecret= system.getenv('CHES_SECRET');
system.out.println(system.getenv())
var mypayload = ""; 
mypayload=mypayload.concat("grant_type=client_credentials&amp;client_id=",clientId,"&amp;client_secret=",clientSecret);
system.out.println ("mypayload: "+mypayload);
mypayload;</camunda:script></camunda:inputParameter><camunda:outputParameter name="token">${S(response).prop("access_token").value()}</camunda:outputParameter><camunda:outputParameter name="Output_36gie1s" /></camunda:inputOutput><camunda:connectorId>http-connector</camunda:connectorId></camunda:connector></bpmn:extensionElements><bpmn:incoming>Flow_0zfq4uk</bpmn:incoming><bpmn:outgoing>Flow_1vbdpqy</bpmn:outgoing></bpmn:serviceTask><bpmn:sequenceFlow id="Flow_1vbdpqy" sourceRef="Activity_0ghr926" targetRef="Activity_0b6rt47" /><bpmn:serviceTask id="ServiceTask_109bpge" name="Send Notification Email"><bpmn:extensionElements><camunda:connector><camunda:inputOutput><camunda:inputParameter name="url"><camunda:script scriptFormat="groovy">System.getenv("CHES_HOST_URL") + "/api/v1/email"</camunda:script></camunda:inputParameter><camunda:inputParameter name="method">POST</camunda:inputParameter><camunda:inputParameter name="headers"><camunda:map><camunda:entry key="Authorization">Bearer ${token}</camunda:entry><camunda:entry key="Content-Type">application/json</camunda:entry></camunda:map></camunda:inputParameter><camunda:inputParameter name="payload">{
  "bcc": [],
  "bodyType": "html",
  "body": "&lt;h1&gt;Welcome to Common Services Ryan&lt;/h1&gt;&lt;p&gt;Sent by &lt;a href='https://bcgov.github.io/common-hosted-email-service/'&gt;CHES&lt;/a&gt;&lt;/p&gt;",
  "cc": [],
  "delayTS": 0,
  "encoding": "utf-8",
  "from": "ryan.birtch@aot-technologies.com",
  "priority": "normal",
  "subject": "CHES Email Message Test1",
  "to": ["ryan.birtch@aot-technologies.com"],
  "tag": "",
  "attachments": []
}</camunda:inputParameter><camunda:outputParameter name="result">${S(response)}</camunda:outputParameter></camunda:inputOutput><camunda:connectorId>http-connector</camunda:connectorId></camunda:connector></bpmn:extensionElements><bpmn:incoming>Flow_1d3h81u</bpmn:incoming><bpmn:outgoing>Flow_1mfn7zl</bpmn:outgoing></bpmn:serviceTask><bpmn:sequenceFlow id="Flow_1mfn7zl" sourceRef="ServiceTask_109bpge" targetRef="Activity_0rgmp6w" /><bpmn:sequenceFlow id="Flow_0ix6j1b" sourceRef="Activity_0rgmp6w" targetRef="Event_1wzeb82" /><bpmn:scriptTask id="Activity_0rgmp6w" name="Print Result" scriptFormat="javascript"><bpmn:extensionElements><camunda:inputOutput><camunda:outputParameter name="Output_1baula6" /></camunda:inputOutput></bpmn:extensionElements><bpmn:incoming>Flow_1mfn7zl</bpmn:incoming><bpmn:outgoing>Flow_0ix6j1b</bpmn:outgoing><bpmn:script>var system = java.lang.System;
system.out.println ("result: "+result);</bpmn:script></bpmn:scriptTask><bpmn:scriptTask id="Activity_0b6rt47" name="Print Token" scriptFormat="javascript"><bpmn:extensionElements><camunda:inputOutput><camunda:outputParameter name="Output_1baula6" /></camunda:inputOutput></bpmn:extensionElements><bpmn:incoming>Flow_1vbdpqy</bpmn:incoming><bpmn:outgoing>Flow_1d3h81u</bpmn:outgoing><bpmn:script>var system = java.lang.System;
system.out.println ("token: "+token);</bpmn:script></bpmn:scriptTask><bpmn:sequenceFlow id="Flow_1d3h81u" sourceRef="Activity_0b6rt47" targetRef="ServiceTask_109bpge" /></bpmn:process><bpmndi:BPMNDiagram id="BPMNDiagram_1"><bpmndi:BPMNPlane id="BPMNPlane_1" bpmnElement="Process_1bi69f0"><bpmndi:BPMNEdge id="Flow_1d3h81u_di" bpmnElement="Flow_1d3h81u"><di:waypoint x="480" y="267" /><di:waypoint x="510" y="267" /></bpmndi:BPMNEdge><bpmndi:BPMNEdge id="Flow_0ix6j1b_di" bpmnElement="Flow_0ix6j1b"><di:waypoint x="760" y="267" /><di:waypoint x="791" y="267" /><di:waypoint x="791" y="260" /><di:waypoint x="822" y="260" /></bpmndi:BPMNEdge><bpmndi:BPMNEdge id="Flow_1mfn7zl_di" bpmnElement="Flow_1mfn7zl"><di:waypoint x="610" y="267" /><di:waypoint x="660" y="267" /></bpmndi:BPMNEdge><bpmndi:BPMNEdge id="Flow_1vbdpqy_di" bpmnElement="Flow_1vbdpqy"><di:waypoint x="360" y="267" /><di:waypoint x="380" y="267" /></bpmndi:BPMNEdge><bpmndi:BPMNEdge id="Flow_0zfq4uk_di" bpmnElement="Flow_0zfq4uk"><di:waypoint x="215" y="267" /><di:waypoint x="260" y="267" /></bpmndi:BPMNEdge><bpmndi:BPMNShape id="_BPMNShape_StartEvent_2" bpmnElement="StartEvent_1"><dc:Bounds x="179" y="249" width="36" height="36" /><bpmndi:BPMNLabel><dc:Bounds x="186" y="292" width="23" height="14" /></bpmndi:BPMNLabel></bpmndi:BPMNShape><bpmndi:BPMNShape id="Event_1wzeb82_di" bpmnElement="Event_1wzeb82"><dc:Bounds x="822" y="242" width="36" height="36" /><bpmndi:BPMNLabel><dc:Bounds x="831" y="285" width="19" height="14" /></bpmndi:BPMNLabel></bpmndi:BPMNShape><bpmndi:BPMNShape id="Activity_0ghr926_di" bpmnElement="Activity_0ghr926"><dc:Bounds x="260" y="227" width="100" height="80" /></bpmndi:BPMNShape><bpmndi:BPMNShape id="ServiceTask_109bpge_di" bpmnElement="ServiceTask_109bpge"><dc:Bounds x="510" y="227" width="100" height="80" /><bpmndi:BPMNLabel /></bpmndi:BPMNShape><bpmndi:BPMNShape id="Activity_1r8t22e_di" bpmnElement="Activity_0rgmp6w"><dc:Bounds x="660" y="227" width="100" height="80" /><bpmndi:BPMNLabel /></bpmndi:BPMNShape><bpmndi:BPMNShape id="BPMNShape_1ve2jop" bpmnElement="Activity_0b6rt47"><dc:Bounds x="380" y="227" width="100" height="80" /><bpmndi:BPMNLabel /></bpmndi:BPMNShape></bpmndi:BPMNPlane></bpmndi:BPMNDiagram></bpmn:definitions>