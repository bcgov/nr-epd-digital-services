
FROM maven:3.8.1-openjdk-17-slim AS MAVEN_TOOL_CHAIN

# expect a build-time variable
ARG FORMFLOW_SOURCE_REPO_BRANCH
# use the value to set the ENV var default
ENV FORMFLOW_SOURCE_REPO_BRANCH master
# expect a build-time variable
ARG FORMFLOW_SOURCE_REPO_URL
# use the value to set the ENV var default
ENV FORMFLOW_SOURCE_REPO_URL https://github.com/AOT-Technologies/forms-flow-ai

ARG KEYCLOAK_URL
ARG KEYCLOAK_URL_REALM
ARG KEYCLOAK_CLIENTID
ARG KEYCLOAK_CLIENTSECRET
ARG CAMUNDA_JDBC_URL
ARG CAMUNDA_JDBC_USER
ARG CAMUNDA_JDBC_PASSWORD
ARG CAMUNDA_JDBC_DRIVER
ARG CAMUNDA_APP_ROOT_LOG_FLAG
ARG FORMSFLOW_API_URL
ARG FORMIO_URL
ARG FORMIO_ROOT_EMAIL
ARG FORMIO_ROOT_PASSWORD
ARG APP_SECURITY_ORIGIN
ARG WEBSOCKET_SECURITY_ORIGIN
ARG WEBSOCKET_MESSAGE_TYPE
ARG WEBSOCKET_ENCRYPT_KEY
ARG DATA_BUFFER_SIZE
ARG IDENTITY_PROVIDER_MAX_RESULT_SIZE
ARG KEYCLOAK_WEB_CLIENTID
ARG KEYCLOAK_ENABLE_CLIENT_AUTH
ARG BPM_CLIENT_CONN_TIMEOUT
ARG DATA_ANALYSIS_URL
ARG CUSTOM_SUBMISSION_URL
ARG CUSTOM_SUBMISSION_ENABLED
ARG CHES_HOST_URL
ARG MULTI_TENANCY_ENABLED
ARG FORMSFLOW_ADMIN_URL
ARG REDIS_ENABLED
ARG REDIS_HOST
ARG REDIS_PORT
ARG REDIS_PASSCODE
ARG SESSION_COOKIE_SECURE
ARG CHES_CLIENT_ID
ARG CHES_SECRET
ARG CHES_AUTH_URL

ENV KEYCLOAK_URL: ${KEYCLOAK_URL}
ENV KEYCLOAK_URL_REALM: ${KEYCLOAK_URL_REALM:-forms-flow-ai}
ENV KEYCLOAK_CLIENTID: ${KEYCLOAK_BPM_CLIENT_ID:-forms-flow-bpm}
ENV KEYCLOAK_CLIENTSECRET: ${KEYCLOAK_BPM_CLIENT_SECRET:-e4bdbd25-1467-4f7f-b993-bc4b1944c943}
ENV CAMUNDA_JDBC_URL: ${CAMUNDA_JDBC_URL:-jdbc:postgresql://forms-flow-bpm-db:5432/formsflow-bpm}
ENV CAMUNDA_JDBC_USER: ${CAMUNDA_JDBC_USER:-admin}
ENV CAMUNDA_JDBC_PASSWORD: ${CAMUNDA_JDBC_PASSWORD:-changeme}
ENV CAMUNDA_JDBC_DRIVER: ${CAMUNDA_JDBC_DRIVER:-org.postgresql.Driver}
ENV CAMUNDA_APP_ROOT_LOG_FLAG: ${CAMUNDA_APP_ROOT_LOG_FLAG:-error}
ENV FORMSFLOW_API_URL: ${FORMSFLOW_API_URL}
ENV FORMIO_URL: ${FORMIO_DEFAULT_PROJECT_URL}
ENV FORMIO_ROOT_EMAIL: ${FORMIO_ROOT_EMAIL:-admin@example.com}
ENV FORMIO_ROOT_PASSWORD: ${FORMIO_ROOT_PASSWORD:-changeme}
ENV APP_SECURITY_ORIGIN: ${APP_SECURITY_ORIGIN:-*}
ENV WEBSOCKET_SECURITY_ORIGIN: ${WEBSOCKET_SECURITY_ORIGIN}
ENV WEBSOCKET_MESSAGE_TYPE: ${WEBSOCKET_MESSAGE_TYPE:-TASK_EVENT}
ENV WEBSOCKET_ENCRYPT_KEY: ${WEBSOCKET_ENCRYPT_KEY:-giert989jkwrgb@DR55}
ENV DATA_BUFFER_SIZE: ${DATA_BUFFER_SIZE:-2}
ENV IDENTITY_PROVIDER_MAX_RESULT_SIZE: ${IDENTITY_PROVIDER_MAX_RESULT_SIZE:-250}
ENV KEYCLOAK_WEB_CLIENTID: ${KEYCLOAK_WEB_CLIENTID:-}
ENV KEYCLOAK_ENABLE_CLIENT_AUTH: ${KEYCLOAK_ENABLE_CLIENT_AUTH:-false}
ENV BPM_CLIENT_CONN_TIMEOUT: ${BPM_CLIENT_CONN_TIMEOUT:-5000}
ENV DATA_ANALYSIS_URL: ${DATA_ANALYSIS_URL}
ENV CUSTOM_SUBMISSION_URL: ${CUSTOM_SUBMISSION_URL}
ENV CUSTOM_SUBMISSION_ENABLED: ${CUSTOM_SUBMISSION_ENABLED:-false}
ENV CHES_HOST_URL: ${CHES_HOST_URL}
ENV MULTI_TENANCY_ENABLED: ${MULTI_TENANCY_ENABLED:-false}
ENV FORMSFLOW_ADMIN_URL: ${FORMSFLOW_ADMIN_URL:-}
ENV REDIS_ENABLED: ${REDIS_ENABLED:-false}
ENV REDIS_HOST: ${REDIS_HOST}
ENV REDIS_PORT: ${REDIS_PORT:-6379}
ENV REDIS_PASSCODE: ${REDIS_PASSCODE:-changeme}
ENV SESSION_COOKIE_SECURE: ${SESSION_COOKIE_SECURE:-false}
ENV CHES_CLIENT_ID: ${CHES_CLIENT_ID}
ENV CHES_SECRET: ${CHES_SECRET}
ENV CHES_AUTH_URL: ${CHES_AUTH_URL}

# set working directory
#WORKDIR /forms-flow-bpm/app

FROM node:14.17.0-alpine as build-stage

RUN apk update && apk upgrade && \
    apk add --no-cache bash git openssh

# Clone code
RUN git clone -b ${FORMFLOW_SOURCE_REPO_BRANCH} ${FORMFLOW_SOURCE_REPO_URL} /tmp/forms-flow-ai/
RUN cp -r /tmp/forms-flow-ai/forms-flow-bpm/. /forms-flow-bpm/app

# Maven build
# COPY pom*.xml /forms-flow-bpm/app/
COPY /forms-flow-bpm/app/settings-docker.xml /usr/share/maven/ref/
WORKDIR /forms-flow-bpm/app/
# This allows Docker to cache most of the maven dependencies
RUN mvn -s /usr/share/maven/ref/settings-docker.xml dependency:resolve-plugins dependency:resolve dependency:go-offline -B
# COPY src /tmp/src/
RUN mvn -s /usr/share/maven/ref/settings-docker.xml package -P default

# Final custom slim java image (for apk command see 17-jdk-alpine-slim)
FROM openjdk:17-jdk-alpine

ENV JAVA_VERSION=17-ea+14
ENV JAVA_HOME=/opt/java/openjdk-17\
    PATH="/opt/java/openjdk-17/bin:$PATH"

EXPOSE 8080
# OpenShift has /app in the image, but it's missing when doing local development - Create it when missing
RUN test ! -d /app && mkdir /app || :
# Add spring boot application
RUN mkdir -p /app
COPY --from=MAVEN_TOOL_CHAIN /forms-flow-bpm/app/tmp/target/forms-flow-bpm.jar ./app
RUN chmod a+rwx -R /app
WORKDIR /app
VOLUME /tmp
ENTRYPOINT ["java","-Djava.security.egd=file:/dev/./urandom", "-Dpolyglot.js.nashorn-compat=true", "-Dpolyglot.engine.WarnInterpreterOnly=false", "-jar","/app/forms-flow-bpm.jar"]