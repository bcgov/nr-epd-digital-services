<?xml version="1.0" encoding="UTF-8"?>
<bpmn:definitions xmlns:bpmn="http://www.omg.org/spec/BPMN/20100524/MODEL" xmlns:bpmndi="http://www.omg.org/spec/BPMN/20100524/DI" xmlns:dc="http://www.omg.org/spec/DD/20100524/DC" xmlns:camunda="http://camunda.org/schema/1.0/bpmn" xmlns:xsi="http://www.w3.org/2001/XMLSchema-instance" xmlns:di="http://www.omg.org/spec/DD/20100524/DI" xmlns:modeler="http://camunda.org/schema/modeler/1.0" id="Definitions_1rb8wsa" targetNamespace="http://bpmn.io/schema/bpmn" exporter="Camunda Modeler" exporterVersion="5.8.0" modeler:executionPlatform="Camunda Platform" modeler:executionPlatformVersion="7.17.0">
  <bpmn:collaboration id="Collaboration_14e80c3">
    <bpmn:participant id="Participant_1569q03" name="SDS Workflow 1.0" processRef="Process_0lizw8k" />
  </bpmn:collaboration>
  <bpmn:process id="Process_0lizw8k" name="EPD SDM Workflow 1" isExecutable="true">
    <bpmn:laneSet id="LaneSet_0mph3xb">
      <bpmn:lane id="Lane_1mfcqjo" name="Client or QualifiedProfessional">
        <bpmn:flowNodeRef>Event_02fettt</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Activity_1ozfgid</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Gateway_1hxeyer</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Activity_1ljp4g2</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Gateway_186l6ll</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Activity_0apywdi</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Task_05ulff4</bpmn:flowNodeRef>
      </bpmn:lane>
      <bpmn:lane id="Lane_1th7fqb" name="Approving Authority">
        <bpmn:flowNodeRef>Activity_16ugfrt</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Activity_1sou6q8</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Activity_08x5mrp</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Activity_03zwbvl</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Activity_06tqtfl</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Activity_1447pa9</bpmn:flowNodeRef>
      </bpmn:lane>
      <bpmn:lane id="Lane_1xv1agn" name="Site Information Advisor (SIA)">
        <bpmn:flowNodeRef>Activity_1l09sve</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Activity_06nypz0</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Task_1hko8r7</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Activity_0lq6ziu</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Event_1wzeb82</bpmn:flowNodeRef>
      </bpmn:lane>
      <bpmn:lane id="Lane_1r3j192" name="Site Risk Classification Officer">
        <bpmn:flowNodeRef>Activity_0ghr926</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Activity_0b6rt47</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>Activity_0rgmp6w</bpmn:flowNodeRef>
        <bpmn:flowNodeRef>ServiceTask_109bpge</bpmn:flowNodeRef>
      </bpmn:lane>
    </bpmn:laneSet>
    <bpmn:sequenceFlow id="Flow_0ortykn" name="No, Sent To SIA" sourceRef="Gateway_186l6ll" targetRef="Activity_1l09sve">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">${doNotNeedsApprovingAuthority== true}</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="Flow_16z3rjh" sourceRef="Activity_06nypz0" targetRef="Activity_0ghr926" />
    <bpmn:sequenceFlow id="Flow_1rk3cb8" sourceRef="Task_1hko8r7" targetRef="Task_05ulff4">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">${action == 'Returned' &amp;&amp; doNotNeedsApprovingAuthority== true}</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="Flow_0h8ke5g" sourceRef="Activity_16ugfrt" targetRef="Task_05ulff4" />
    <bpmn:sequenceFlow id="Flow_0xdqhqi" sourceRef="Activity_1sou6q8" targetRef="Activity_1l09sve" />
    <bpmn:sequenceFlow id="Flow_10pber6" sourceRef="Task_1hko8r7" targetRef="Activity_08x5mrp">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">${action == 'Returned' &amp;&amp; doNotNeedsApprovingAuthority== false}</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="Flow_13bh59o" sourceRef="Task_1hko8r7" targetRef="Task_05ulff4">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">${action == 'ReturnedToClient'}</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="Flow_1t5p6qt" name="QP Submits" sourceRef="Activity_1ozfgid" targetRef="Activity_1ljp4g2">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">${isAgentFillingForm== true}</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="Flow_0oxvo90" sourceRef="Activity_1ljp4g2" targetRef="Gateway_186l6ll" />
    <bpmn:sequenceFlow id="Flow_1rssitl" sourceRef="Gateway_1hxeyer" targetRef="Activity_1l09sve">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">${doNotNeedsApprovingAuthority== true}</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="Flow_1k3d8eq" name="No AA Email" sourceRef="Activity_0apywdi" targetRef="Activity_1447pa9">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">${execution.getVariable("ApprovingAuthEmail") == null}</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="Flow_0amyink" name="Yes, Sent To AA" sourceRef="Gateway_186l6ll" targetRef="Activity_0apywdi">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">${doNotNeedsApprovingAuthority== false}</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:exclusiveGateway id="Gateway_186l6ll" name="Requires Muncipality Approval ?">
      <bpmn:incoming>Flow_0oxvo90</bpmn:incoming>
      <bpmn:outgoing>Flow_0ortykn</bpmn:outgoing>
      <bpmn:outgoing>Flow_0amyink</bpmn:outgoing>
    </bpmn:exclusiveGateway>
    <bpmn:userTask id="Activity_1ljp4g2" camunda:assignee="${hiddenUserIdForFormSharing}">
      <bpmn:incoming>Flow_1t5p6qt</bpmn:incoming>
      <bpmn:outgoing>Flow_0oxvo90</bpmn:outgoing>
    </bpmn:userTask>
    <bpmn:sequenceFlow id="Flow_1gf5oiz" name="AA Email Entered" sourceRef="Activity_0apywdi" targetRef="Activity_08x5mrp">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">${execution.getVariable("ApprovingAuthEmail") != null}</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="Flow_1xvd3j3" sourceRef="Gateway_1hxeyer" targetRef="Activity_0apywdi">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">${doNotNeedsApprovingAuthority== false}</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="Flow_0unffch" name="Owner Submits" sourceRef="Activity_1ozfgid" targetRef="Gateway_1hxeyer">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">${isAgentFillingForm== false}</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="Flow_1la2yud" sourceRef="Event_02fettt" targetRef="Activity_1ozfgid">
      <bpmn:extensionElements>
        <camunda:executionListener event="take">
          <camunda:script scriptFormat="javascript">execution.setVariable('applicationStatus', 'New');</camunda:script>
        </camunda:executionListener>
        <camunda:executionListener class="org.camunda.bpm.extension.hooks.listeners.ApplicationStateListener" event="take" />
        <camunda:executionListener class="org.camunda.bpm.extension.hooks.listeners.BPMFormDataPipelineListener" event="take">
          <camunda:field name="fields">
            <camunda:expression>["applicationId", "applicationStatus"]</camunda:expression>
          </camunda:field>
        </camunda:executionListener>
        <camunda:executionListener class="org.camunda.bpm.extension.hooks.listeners.FormBPMFilteredDataPipelineListener" event="take" />
      </bpmn:extensionElements>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="Flow_07ndmfw" name="Resubmitted Application" sourceRef="Task_05ulff4" targetRef="Activity_1ozfgid">
      <bpmn:extensionElements>
        <camunda:executionListener event="take">
          <camunda:script scriptFormat="javascript">execution.setVariable('applicationStatus', 'Resubmitted');</camunda:script>
        </camunda:executionListener>
        <camunda:executionListener class="org.camunda.bpm.extension.hooks.listeners.ApplicationStateListener" event="take" />
        <camunda:executionListener class="org.camunda.bpm.extension.hooks.listeners.BPMFormDataPipelineListener" event="take">
          <camunda:field name="fields">
            <camunda:expression>["applicationId", "applicationStatus"]</camunda:expression>
          </camunda:field>
        </camunda:executionListener>
      </bpmn:extensionElements>
    </bpmn:sequenceFlow>
    <bpmn:exclusiveGateway id="Gateway_1hxeyer">
      <bpmn:incoming>Flow_0unffch</bpmn:incoming>
      <bpmn:outgoing>Flow_1rssitl</bpmn:outgoing>
      <bpmn:outgoing>Flow_1xvd3j3</bpmn:outgoing>
    </bpmn:exclusiveGateway>
    <bpmn:scriptTask id="Activity_1ozfgid" name="Set Application Context For BPM" scriptFormat="javascript">
      <bpmn:incoming>Flow_1la2yud</bpmn:incoming>
      <bpmn:incoming>Flow_07ndmfw</bpmn:incoming>
      <bpmn:outgoing>Flow_1t5p6qt</bpmn:outgoing>
      <bpmn:outgoing>Flow_0unffch</bpmn:outgoing>
      <bpmn:script>var system = java.lang.System;
var clientEmail= execution.getVariable('contactPersonEmailAddress');
execution.setVariable('clientEmail',clientEmail);
var clientEmail2= execution.getVariable('ownerEmailAddress');
execution.setVariable('clientEmail2',clientEmail2);
var isAgentFillingForm = execution.getVariable('section1BAgentCheckbox');
execution.setVariable('isAgentFillingForm',isAgentFillingForm);
system.out.println ("clientEmail"+clientEmail);
system.out.println ("clientEmail2"+clientEmail2);
system.out.println ("isAgentFillingForm"+isAgentFillingForm);
var checkboxUnderOrder= execution.getVariable('section5DeclarationsCheckboxUnderOrder');
var checkboxBIAProceedings= execution.getVariable('section5DeclarationsCheckboxBIAProceedings');
var checkboxDecommissioning= execution.getVariable('section5DeclarationsCheckboxDecommissioning');
var checkboxForeclosure= execution.getVariable('section5DeclarationsCheckboxForeclosure');
var checkboxCCAAProceedings= execution.getVariable('section5DeclarationsCheckboxCCAAProceedings');
var checkboxCeasingOperations= execution.getVariable('section5DeclarationsCheckboxCeasingOperations');
system.out.println ("section5DeclarationsCheckboxUnderOrder "+section5DeclarationsCheckboxUnderOrder);
var hiddenUserIdForFormSharing= execution.getVariable('hiddenUserIdForFormSharing');
system.out.println ("hiddenUserIdForFormSharing"+hiddenUserIdForFormSharing);
execution.setVariable('doNotNeedsApprovingAuthority',checkboxUnderOrder||checkboxBIAProceedings||checkboxDecommissioning||checkboxForeclosure||checkboxCCAAProceedings||checkboxCeasingOperations);
system.out.println ("doNotNeedsApprovingAuthority"+execution.getVariable('doNotNeedsApprovingAuthority'));</bpmn:script>
    </bpmn:scriptTask>
    <bpmn:startEvent id="Event_02fettt" name="Submit Form">
      <bpmn:outgoing>Flow_1la2yud</bpmn:outgoing>
    </bpmn:startEvent>
    <bpmn:scriptTask id="Activity_0apywdi" name="Debug Log" scriptFormat="javascript">
      <bpmn:incoming>Flow_1xvd3j3</bpmn:incoming>
      <bpmn:incoming>Flow_0amyink</bpmn:incoming>
      <bpmn:outgoing>Flow_1gf5oiz</bpmn:outgoing>
      <bpmn:outgoing>Flow_1k3d8eq</bpmn:outgoing>
      <bpmn:script>var system = java.lang.System;
system.out.println ("Sent to AA ");</bpmn:script>
    </bpmn:scriptTask>
    <bpmn:receiveTask id="Task_05ulff4" name="Application Resubmitted" messageRef="Message_1ngb2eg">
      <bpmn:extensionElements>
        <camunda:executionListener event="start">
          <camunda:script scriptFormat="javascript">execution.setVariable('applicationStatus', "Resubmit");</camunda:script>
        </camunda:executionListener>
        <camunda:executionListener class="org.camunda.bpm.extension.hooks.listeners.FormSubmissionListener" event="start" />
        <camunda:executionListener class="org.camunda.bpm.extension.hooks.listeners.ApplicationStateListener" event="start" />
        <camunda:executionListener class="org.camunda.bpm.extension.hooks.listeners.BPMFormDataPipelineListener" event="start">
          <camunda:field name="fields">
            <camunda:expression>["applicationId", "applicationStatus"]</camunda:expression>
          </camunda:field>
        </camunda:executionListener>
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_1rk3cb8</bpmn:incoming>
      <bpmn:incoming>Flow_0h8ke5g</bpmn:incoming>
      <bpmn:incoming>Flow_13bh59o</bpmn:incoming>
      <bpmn:outgoing>Flow_07ndmfw</bpmn:outgoing>
    </bpmn:receiveTask>
    <bpmn:scriptTask id="Activity_1l09sve" name="Debug Log" scriptFormat="javascript">
      <bpmn:incoming>Flow_0ortykn</bpmn:incoming>
      <bpmn:incoming>Flow_0xdqhqi</bpmn:incoming>
      <bpmn:incoming>Flow_1rssitl</bpmn:incoming>
      <bpmn:outgoing>Flow_0eamj6d</bpmn:outgoing>
      <bpmn:script>var system = java.lang.System;
system.out.println ("Send To SIA");</bpmn:script>
    </bpmn:scriptTask>
    <bpmn:userTask id="Activity_06nypz0" name="Site Information Advisor Reviews" camunda:candidateGroups="formsflow/formsflow-reviewer/site-information-advisor">
      <bpmn:extensionElements>
        <camunda:taskListener event="complete">
          <camunda:script scriptFormat="javascript">task.execution.setVariable('applicationStatus', task.execution.getVariable('action'));
</camunda:script>
        </camunda:taskListener>
        <camunda:formData>
          <camunda:formField id="action" label="Action" type="string" />
        </camunda:formData>
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_0eamj6d</bpmn:incoming>
      <bpmn:outgoing>Flow_16z3rjh</bpmn:outgoing>
    </bpmn:userTask>
    <bpmn:task id="Task_1hko8r7" name="Update Application Status">
      <bpmn:extensionElements>
        <camunda:executionListener class="org.camunda.bpm.extension.hooks.listeners.ApplicationStateListener" event="end" />
        <camunda:executionListener class="org.camunda.bpm.extension.hooks.listeners.BPMFormDataPipelineListener" event="start">
          <camunda:field name="fields">
            <camunda:expression>["applicationId","applicationStatus"]</camunda:expression>
          </camunda:field>
        </camunda:executionListener>
        <camunda:executionListener class="org.camunda.bpm.extension.hooks.listeners.FormSubmissionListener" event="start" />
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_0x85fb7</bpmn:incoming>
      <bpmn:outgoing>Flow_1rk3cb8</bpmn:outgoing>
      <bpmn:outgoing>Flow_0qw6mqs</bpmn:outgoing>
      <bpmn:outgoing>Flow_10pber6</bpmn:outgoing>
      <bpmn:outgoing>Flow_13bh59o</bpmn:outgoing>
    </bpmn:task>
    <bpmn:scriptTask id="Activity_0lq6ziu" name="Debug Log" scriptFormat="javascript">
      <bpmn:incoming>Flow_0qw6mqs</bpmn:incoming>
      <bpmn:outgoing>Flow_17geab4</bpmn:outgoing>
      <bpmn:script>var system = java.lang.System;
system.out.println ("Workflow Complete");</bpmn:script>
    </bpmn:scriptTask>
    <bpmn:endEvent id="Event_1wzeb82" name="end">
      <bpmn:incoming>Flow_17geab4</bpmn:incoming>
    </bpmn:endEvent>
    <bpmn:sequenceFlow id="Flow_0eamj6d" sourceRef="Activity_1l09sve" targetRef="Activity_06nypz0" />
    <bpmn:sequenceFlow id="Flow_0qw6mqs" sourceRef="Task_1hko8r7" targetRef="Activity_0lq6ziu">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">${action != 'Returned'}</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="Flow_17geab4" sourceRef="Activity_0lq6ziu" targetRef="Event_1wzeb82" />
    <bpmn:sequenceFlow id="Flow_1a8o2qo" sourceRef="Activity_06tqtfl" targetRef="Activity_1447pa9" />
    <bpmn:task id="Activity_16ugfrt" name="Update Application Status">
      <bpmn:extensionElements>
        <camunda:executionListener class="org.camunda.bpm.extension.hooks.listeners.ApplicationStateListener" event="end" />
        <camunda:executionListener class="org.camunda.bpm.extension.hooks.listeners.BPMFormDataPipelineListener" event="start">
          <camunda:field name="fields">
            <camunda:expression>["applicationId","applicationStatus"]</camunda:expression>
          </camunda:field>
        </camunda:executionListener>
        <camunda:executionListener class="org.camunda.bpm.extension.hooks.listeners.FormSubmissionListener" event="start" />
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_168b6j6</bpmn:incoming>
      <bpmn:outgoing>Flow_0h8ke5g</bpmn:outgoing>
    </bpmn:task>
    <bpmn:task id="Activity_1sou6q8" name="Update Application Status">
      <bpmn:extensionElements>
        <camunda:executionListener class="org.camunda.bpm.extension.hooks.listeners.ApplicationStateListener" event="end" />
        <camunda:executionListener class="org.camunda.bpm.extension.hooks.listeners.BPMFormDataPipelineListener" event="start">
          <camunda:field name="fields">
            <camunda:expression>["applicationId","applicationStatus"]</camunda:expression>
          </camunda:field>
        </camunda:executionListener>
        <camunda:executionListener class="org.camunda.bpm.extension.hooks.listeners.FormSubmissionListener" event="start" />
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_0cf3t4y</bpmn:incoming>
      <bpmn:outgoing>Flow_0xdqhqi</bpmn:outgoing>
    </bpmn:task>
    <bpmn:sequenceFlow id="Flow_0cf3t4y" sourceRef="Activity_1447pa9" targetRef="Activity_1sou6q8">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">${action != 'Returned'}</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:sequenceFlow id="Flow_168b6j6" sourceRef="Activity_1447pa9" targetRef="Activity_16ugfrt">
      <bpmn:conditionExpression xsi:type="bpmn:tFormalExpression">${action == 'Returned'}</bpmn:conditionExpression>
    </bpmn:sequenceFlow>
    <bpmn:serviceTask id="Activity_08x5mrp" name="Get OAuth Token">
      <bpmn:extensionElements>
        <camunda:connector>
          <camunda:inputOutput>
            <camunda:inputParameter name="url">
              <camunda:script scriptFormat="javascript">var system = java.lang.System;
var authUrl = system.getenv(
'CHES_AUTH_URL');
authUrl;</camunda:script>
            </camunda:inputParameter>
            <camunda:inputParameter name="method">POST</camunda:inputParameter>
            <camunda:inputParameter name="headers">
              <camunda:map>
                <camunda:entry key="Content-Type">application/x-www-form-urlencoded</camunda:entry>
              </camunda:map>
            </camunda:inputParameter>
            <camunda:inputParameter name="payload">
              <camunda:script scriptFormat="javascript">var system = java.lang.System;
var clientId=system.getenv('CHES_CLIENT_ID');
var clientSecret= system.getenv('CHES_SECRET');
system.out.println(system.getenv())
var mypayload = ""; 
mypayload=mypayload.concat("grant_type=client_credentials&amp;client_id=",clientId,"&amp;client_secret=",clientSecret);
system.out.println ("mypayload: "+mypayload);
mypayload;</camunda:script>
            </camunda:inputParameter>
            <camunda:outputParameter name="token">${S(response).prop("access_token").value()}</camunda:outputParameter>
          </camunda:inputOutput>
          <camunda:connectorId>http-connector</camunda:connectorId>
        </camunda:connector>
        <camunda:inputOutput />
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_1gf5oiz</bpmn:incoming>
      <bpmn:incoming>Flow_10pber6</bpmn:incoming>
      <bpmn:outgoing>Flow_1i9z2u9</bpmn:outgoing>
    </bpmn:serviceTask>
    <bpmn:serviceTask id="Activity_03zwbvl" name="Send AA Notification Email">
      <bpmn:extensionElements>
        <camunda:connector>
          <camunda:inputOutput>
            <camunda:inputParameter name="url">
              <camunda:script scriptFormat="groovy">System.getenv("CHES_HOST_URL") + "/api/v1/email"</camunda:script>
            </camunda:inputParameter>
            <camunda:inputParameter name="method">POST</camunda:inputParameter>
            <camunda:inputParameter name="headers">
              <camunda:map>
                <camunda:entry key="Authorization">Bearer ${token}</camunda:entry>
                <camunda:entry key="Content-Type">application/json</camunda:entry>
              </camunda:map>
            </camunda:inputParameter>
            <camunda:inputParameter name="payload">
              <camunda:script scriptFormat="javascript">var AAEmail = execution.getVariable("ApprovingAuthEmail")
var p = {
  "bcc": [],
  "bodyType": "html",
  "body": "You have an application that has been returned to you. Please login to review and resubmit. Application Status: " + execution.getVariable('applicationStatus'),
  "cc": [],
  "delayTS": 0,
  "encoding": "utf-8",
  "from": "NOREPLYEPD@gov.bc.ca",
  "priority": "normal",
  "subject": "EPD Application Update, Approving Authority",
  "to": ["ryan.birtch@aot-technologies.com"],
  "tag": "",
  "attachments": []
}
p.to.push(AAEmail)
console.log("Payload")
console.log(JSON.stringify(p))
JSON.stringify(p)</camunda:script>
            </camunda:inputParameter>
            <camunda:outputParameter name="result">${S(response)}</camunda:outputParameter>
          </camunda:inputOutput>
          <camunda:connectorId>http-connector</camunda:connectorId>
        </camunda:connector>
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_1i9z2u9</bpmn:incoming>
      <bpmn:outgoing>Flow_0b8wrvw</bpmn:outgoing>
    </bpmn:serviceTask>
    <bpmn:scriptTask id="Activity_06tqtfl" name="Debug Log" scriptFormat="javascript">
      <bpmn:extensionElements>
        <camunda:inputOutput />
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_0b8wrvw</bpmn:incoming>
      <bpmn:outgoing>Flow_1a8o2qo</bpmn:outgoing>
      <bpmn:script>var system = java.lang.System;
system.out.println ("result: "+result);</bpmn:script>
    </bpmn:scriptTask>
    <bpmn:sequenceFlow id="Flow_1i9z2u9" sourceRef="Activity_08x5mrp" targetRef="Activity_03zwbvl" />
    <bpmn:sequenceFlow id="Flow_0b8wrvw" sourceRef="Activity_03zwbvl" targetRef="Activity_06tqtfl" />
    <bpmn:userTask id="Activity_1447pa9" name="Approval Authority Updates Forms" camunda:candidateGroups="formsflow/formsflow-reviewer/lrs-approving-authority">
      <bpmn:extensionElements>
        <camunda:taskListener event="complete">
          <camunda:script scriptFormat="javascript">task.execution.setVariable('applicationStatus', task.execution.getVariable('action'));
</camunda:script>
        </camunda:taskListener>
        <camunda:formData>
          <camunda:formField id="action" label="Action" type="string" />
        </camunda:formData>
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_1k3d8eq</bpmn:incoming>
      <bpmn:incoming>Flow_1a8o2qo</bpmn:incoming>
      <bpmn:outgoing>Flow_168b6j6</bpmn:outgoing>
      <bpmn:outgoing>Flow_0cf3t4y</bpmn:outgoing>
    </bpmn:userTask>
    <bpmn:serviceTask id="Activity_0ghr926" name="Get OAuth Token">
      <bpmn:extensionElements>
        <camunda:connector>
          <camunda:inputOutput>
            <camunda:inputParameter name="url">
              <camunda:script scriptFormat="javascript">var system = java.lang.System;
var authUrl = system.getenv(
'CHES_AUTH_URL');
authUrl;</camunda:script>
            </camunda:inputParameter>
            <camunda:inputParameter name="method">POST</camunda:inputParameter>
            <camunda:inputParameter name="headers">
              <camunda:map>
                <camunda:entry key="Content-Type">application/x-www-form-urlencoded</camunda:entry>
              </camunda:map>
            </camunda:inputParameter>
            <camunda:inputParameter name="payload">
              <camunda:script scriptFormat="javascript">var system = java.lang.System;
var clientId=system.getenv('CHES_CLIENT_ID');
var clientSecret= system.getenv('CHES_SECRET');
system.out.println(system.getenv())
var mypayload = ""; 
mypayload=mypayload.concat("grant_type=client_credentials&amp;client_id=",clientId,"&amp;client_secret=",clientSecret);
system.out.println ("mypayload: "+mypayload);
mypayload;</camunda:script>
            </camunda:inputParameter>
            <camunda:outputParameter name="token">${S(response).prop("access_token").value()}</camunda:outputParameter>
          </camunda:inputOutput>
          <camunda:connectorId>http-connector</camunda:connectorId>
        </camunda:connector>
        <camunda:inputOutput />
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_16z3rjh</bpmn:incoming>
      <bpmn:outgoing>Flow_1vbdpqy</bpmn:outgoing>
    </bpmn:serviceTask>
    <bpmn:scriptTask id="Activity_0b6rt47" name="Print Token" scriptFormat="javascript">
      <bpmn:extensionElements>
        <camunda:inputOutput>
          <camunda:inputParameter name="Input_06q9n0v" />
        </camunda:inputOutput>
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_1vbdpqy</bpmn:incoming>
      <bpmn:outgoing>Flow_1d3h81u</bpmn:outgoing>
      <bpmn:script>var system = java.lang.System;
system.out.println ("token: "+token);</bpmn:script>
    </bpmn:scriptTask>
    <bpmn:sequenceFlow id="Flow_1vbdpqy" sourceRef="Activity_0ghr926" targetRef="Activity_0b6rt47" />
    <bpmn:sequenceFlow id="Flow_1d3h81u" sourceRef="Activity_0b6rt47" targetRef="ServiceTask_109bpge" />
    <bpmn:scriptTask id="Activity_0rgmp6w" name="Print Result" scriptFormat="javascript">
      <bpmn:extensionElements>
        <camunda:inputOutput />
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_1mfn7zl</bpmn:incoming>
      <bpmn:outgoing>Flow_0x85fb7</bpmn:outgoing>
      <bpmn:script>var system = java.lang.System;
system.out.println ("result: "+result);</bpmn:script>
    </bpmn:scriptTask>
    <bpmn:serviceTask id="ServiceTask_109bpge" name="Send Notification Email">
      <bpmn:extensionElements>
        <camunda:connector>
          <camunda:inputOutput>
            <camunda:inputParameter name="url">
              <camunda:script scriptFormat="groovy">System.getenv("CHES_HOST_URL") + "/api/v1/email"</camunda:script>
            </camunda:inputParameter>
            <camunda:inputParameter name="method">POST</camunda:inputParameter>
            <camunda:inputParameter name="headers">
              <camunda:map>
                <camunda:entry key="Authorization">Bearer ${token}</camunda:entry>
                <camunda:entry key="Content-Type">application/json</camunda:entry>
              </camunda:map>
            </camunda:inputParameter>
            <camunda:inputParameter name="payload">
              <camunda:script scriptFormat="javascript">var p = {
  "bcc": [],
  "bodyType": "html",
  "body": "You have an update to your application, please log in to review. The status is: " + execution.getVariable('applicationStatus'),
  "cc": [],
  "delayTS": 0,
  "encoding": "utf-8",
  "from": "NOREPLYEPD@gov.bc.ca",
  "priority": "normal",
  "subject": "EPD Application Update",
  "to": ["ryan.birtch@aot-technologies.com"],
  "tag": "",
  "attachments": []
}
p.to.push(clientEmail)
p.to.push(clientEmail2)
console.log("Payload")
console.log(JSON.stringify(p))
JSON.stringify(p)</camunda:script>
            </camunda:inputParameter>
            <camunda:outputParameter name="result">${S(response)}</camunda:outputParameter>
          </camunda:inputOutput>
          <camunda:connectorId>http-connector</camunda:connectorId>
        </camunda:connector>
      </bpmn:extensionElements>
      <bpmn:incoming>Flow_1d3h81u</bpmn:incoming>
      <bpmn:outgoing>Flow_1mfn7zl</bpmn:outgoing>
    </bpmn:serviceTask>
    <bpmn:sequenceFlow id="Flow_1mfn7zl" sourceRef="ServiceTask_109bpge" targetRef="Activity_0rgmp6w" />
    <bpmn:sequenceFlow id="Flow_0x85fb7" sourceRef="Activity_0rgmp6w" targetRef="Task_1hko8r7" />
  </bpmn:process>
  <bpmn:message id="Message_1ngb2eg" name="application_resubmitted" />
  <bpmndi:BPMNDiagram id="BPMNDiagram_1">
    <bpmndi:BPMNPlane id="BPMNPlane_1" bpmnElement="Collaboration_14e80c3">
      <bpmndi:BPMNShape id="Participant_1569q03_di" bpmnElement="Participant_1569q03" isHorizontal="true">
        <dc:Bounds x="160" y="80" width="1330" height="1265" />
        <bpmndi:BPMNLabel />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Lane_1mfcqjo_di" bpmnElement="Lane_1mfcqjo" isHorizontal="true">
        <dc:Bounds x="190" y="80" width="1300" height="336" />
        <bpmndi:BPMNLabel />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Lane_1th7fqb_di" bpmnElement="Lane_1th7fqb" isHorizontal="true">
        <dc:Bounds x="190" y="416" width="1300" height="344" />
        <bpmndi:BPMNLabel />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Lane_1xv1agn_di" bpmnElement="Lane_1xv1agn" isHorizontal="true">
        <dc:Bounds x="190" y="760" width="1300" height="320" />
        <bpmndi:BPMNLabel />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Lane_1r3j192_di" bpmnElement="Lane_1r3j192" isHorizontal="true">
        <dc:Bounds x="190" y="1080" width="1300" height="265" />
        <bpmndi:BPMNLabel />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="BPMNShape_0s7tget" bpmnElement="Event_02fettt">
        <dc:Bounds x="232" y="122" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="219" y="98" width="63" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="BPMNShape_0zk5qh7" bpmnElement="Activity_1ozfgid">
        <dc:Bounds x="270" y="242" width="100" height="80" />
        <bpmndi:BPMNLabel />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Gateway_1hxeyer_di" bpmnElement="Gateway_1hxeyer" isMarkerVisible="true">
        <dc:Bounds x="455" y="245" width="50" height="50" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_0icmtj8_di" bpmnElement="Activity_1ljp4g2">
        <dc:Bounds x="360" y="330" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="BPMNShape_00bglf3" bpmnElement="Gateway_186l6ll" isMarkerVisible="true">
        <dc:Bounds x="485" y="345" width="50" height="50" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="482" y="295" width="56" height="40" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_0xnvv52_di" bpmnElement="Activity_0apywdi">
        <dc:Bounds x="775" y="270" width="100" height="80" />
        <bpmndi:BPMNLabel />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="ReceiveTask_1pd77zg_di" bpmnElement="Task_05ulff4">
        <dc:Bounds x="550" y="140" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_04puqw7_di" bpmnElement="Activity_1l09sve">
        <dc:Bounds x="430" y="790" width="100" height="80" />
        <bpmndi:BPMNLabel />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="BPMNShape_12ki2vi" bpmnElement="Activity_06nypz0">
        <dc:Bounds x="430" y="910" width="100" height="80" />
        <bpmndi:BPMNLabel />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Task_0fde0ul_di" bpmnElement="Task_1hko8r7">
        <dc:Bounds x="550" y="910" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="BPMNShape_0n4dhju" bpmnElement="Activity_0lq6ziu">
        <dc:Bounds x="760" y="970" width="100" height="80" />
        <bpmndi:BPMNLabel />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Event_1wzeb82_di" bpmnElement="Event_1wzeb82">
        <dc:Bounds x="1032" y="992" width="36" height="36" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="1040" y="968" width="19" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="BPMNShape_0qeqd26" bpmnElement="Activity_16ugfrt">
        <dc:Bounds x="1120" y="660" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="BPMNShape_0wsljwg" bpmnElement="Activity_1sou6q8">
        <dc:Bounds x="1290" y="660" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="BPMNShape_044b8tq" bpmnElement="Activity_08x5mrp">
        <dc:Bounds x="740" y="580" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="BPMNShape_0vpgves" bpmnElement="Activity_03zwbvl">
        <dc:Bounds x="870" y="580" width="100" height="80" />
        <bpmndi:BPMNLabel />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="BPMNShape_0gki1xj" bpmnElement="Activity_06tqtfl">
        <dc:Bounds x="1000" y="580" width="100" height="80" />
        <bpmndi:BPMNLabel />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_0e1i3mr_di" bpmnElement="Activity_1447pa9">
        <dc:Bounds x="1210" y="500" width="100" height="80" />
        <bpmndi:BPMNLabel />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_0ghr926_di" bpmnElement="Activity_0ghr926">
        <dc:Bounds x="280" y="1120" width="100" height="80" />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="BPMNShape_1ve2jop" bpmnElement="Activity_0b6rt47">
        <dc:Bounds x="400" y="1120" width="100" height="80" />
        <bpmndi:BPMNLabel />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="Activity_1r8t22e_di" bpmnElement="Activity_0rgmp6w">
        <dc:Bounds x="650" y="1120" width="100" height="80" />
        <bpmndi:BPMNLabel />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNShape id="ServiceTask_109bpge_di" bpmnElement="ServiceTask_109bpge">
        <dc:Bounds x="520" y="1120" width="100" height="80" />
        <bpmndi:BPMNLabel />
      </bpmndi:BPMNShape>
      <bpmndi:BPMNEdge id="BPMNEdge_180n8hx" bpmnElement="Flow_1la2yud">
        <di:waypoint x="250" y="158" />
        <di:waypoint x="250" y="282" />
        <di:waypoint x="270" y="282" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_0amyink_di" bpmnElement="Flow_0amyink">
        <di:waypoint x="535" y="370" />
        <di:waypoint x="655" y="370" />
        <di:waypoint x="655" y="310" />
        <di:waypoint x="775" y="310" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="631" y="287" width="78" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_0ortykn_di" bpmnElement="Flow_0ortykn">
        <di:waypoint x="510" y="395" />
        <di:waypoint x="510" y="790" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="430" y="457" width="79" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_16z3rjh_di" bpmnElement="Flow_16z3rjh">
        <di:waypoint x="430" y="950" />
        <di:waypoint x="260" y="950" />
        <di:waypoint x="260" y="1160" />
        <di:waypoint x="280" y="1160" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_1rk3cb8_di" bpmnElement="Flow_1rk3cb8">
        <di:waypoint x="650" y="950" />
        <di:waypoint x="715" y="950" />
        <di:waypoint x="715" y="180" />
        <di:waypoint x="650" y="180" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_07ndmfw_di" bpmnElement="Flow_07ndmfw">
        <di:waypoint x="550" y="160" />
        <di:waypoint x="320" y="160" />
        <di:waypoint x="320" y="242" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="405" y="126" width="62" height="27" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_0h8ke5g_di" bpmnElement="Flow_0h8ke5g">
        <di:waypoint x="1120" y="700" />
        <di:waypoint x="600" y="700" />
        <di:waypoint x="600" y="220" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_0xdqhqi_di" bpmnElement="Flow_0xdqhqi">
        <di:waypoint x="1340" y="740" />
        <di:waypoint x="1340" y="830" />
        <di:waypoint x="530" y="830" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_10pber6_di" bpmnElement="Flow_10pber6">
        <di:waypoint x="650" y="930" />
        <di:waypoint x="760" y="930" />
        <di:waypoint x="760" y="660" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_13bh59o_di" bpmnElement="Flow_13bh59o">
        <di:waypoint x="570" y="910" />
        <di:waypoint x="570" y="220" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_1t5p6qt_di" bpmnElement="Flow_1t5p6qt">
        <di:waypoint x="320" y="322" />
        <di:waypoint x="320" y="370" />
        <di:waypoint x="360" y="370" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="380" y="373" width="59" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_0oxvo90_di" bpmnElement="Flow_0oxvo90">
        <di:waypoint x="460" y="370" />
        <di:waypoint x="485" y="370" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_0unffch_di" bpmnElement="Flow_0unffch">
        <di:waypoint x="370" y="270" />
        <di:waypoint x="455" y="270" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="375" y="252" width="76" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_1rssitl_di" bpmnElement="Flow_1rssitl">
        <di:waypoint x="480" y="295" />
        <di:waypoint x="480" y="790" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_1xvd3j3_di" bpmnElement="Flow_1xvd3j3">
        <di:waypoint x="505" y="270" />
        <di:waypoint x="623" y="270" />
        <di:waypoint x="623" y="310" />
        <di:waypoint x="775" y="310" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="BPMNEdge_05bk6gz" bpmnElement="Flow_1gf5oiz">
        <di:waypoint x="825" y="350" />
        <di:waypoint x="825" y="465" />
        <di:waypoint x="765" y="465" />
        <di:waypoint x="765" y="580" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="727" y="443" width="86" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_1k3d8eq_di" bpmnElement="Flow_1k3d8eq">
        <di:waypoint x="870" y="350" />
        <di:waypoint x="870" y="540" />
        <di:waypoint x="1210" y="540" />
        <bpmndi:BPMNLabel>
          <dc:Bounds x="919" y="523" width="62" height="14" />
        </bpmndi:BPMNLabel>
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_0eamj6d_di" bpmnElement="Flow_0eamj6d">
        <di:waypoint x="480" y="870" />
        <di:waypoint x="480" y="910" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_0qw6mqs_di" bpmnElement="Flow_0qw6mqs">
        <di:waypoint x="600" y="990" />
        <di:waypoint x="600" y="1010" />
        <di:waypoint x="760" y="1010" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_17geab4_di" bpmnElement="Flow_17geab4">
        <di:waypoint x="860" y="1010" />
        <di:waypoint x="1032" y="1010" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_1a8o2qo_di" bpmnElement="Flow_1a8o2qo">
        <di:waypoint x="1100" y="620" />
        <di:waypoint x="1185" y="620" />
        <di:waypoint x="1185" y="560" />
        <di:waypoint x="1210" y="560" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_0cf3t4y_di" bpmnElement="Flow_0cf3t4y">
        <di:waypoint x="1310" y="570" />
        <di:waypoint x="1340" y="570" />
        <di:waypoint x="1340" y="660" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_168b6j6_di" bpmnElement="Flow_168b6j6">
        <di:waypoint x="1210" y="570" />
        <di:waypoint x="1210" y="640" />
        <di:waypoint x="1140" y="640" />
        <di:waypoint x="1140" y="660" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_1i9z2u9_di" bpmnElement="Flow_1i9z2u9">
        <di:waypoint x="840" y="620" />
        <di:waypoint x="870" y="620" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_0b8wrvw_di" bpmnElement="Flow_0b8wrvw">
        <di:waypoint x="970" y="620" />
        <di:waypoint x="1000" y="620" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_1vbdpqy_di" bpmnElement="Flow_1vbdpqy">
        <di:waypoint x="380" y="1160" />
        <di:waypoint x="400" y="1160" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_1d3h81u_di" bpmnElement="Flow_1d3h81u">
        <di:waypoint x="500" y="1160" />
        <di:waypoint x="520" y="1160" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_1mfn7zl_di" bpmnElement="Flow_1mfn7zl">
        <di:waypoint x="620" y="1160" />
        <di:waypoint x="650" y="1160" />
      </bpmndi:BPMNEdge>
      <bpmndi:BPMNEdge id="Flow_0x85fb7_di" bpmnElement="Flow_0x85fb7">
        <di:waypoint x="700" y="1120" />
        <di:waypoint x="700" y="1055" />
        <di:waypoint x="570" y="1055" />
        <di:waypoint x="570" y="990" />
      </bpmndi:BPMNEdge>
    </bpmndi:BPMNPlane>
  </bpmndi:BPMNDiagram>
</bpmn:definitions>
